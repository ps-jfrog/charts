# Helper scripts: parallel command runners

Two scripts run shell commands in parallel with a concurrency limit, log failures to a file, and clean up temporary files. They are used to execute reconciliation scripts generated by **compare-and-reconcile.sh** (e.g. `03_to_sync.sh`, `05_to_sync_stats.sh`).

| Script | Input | Use when |
|--------|--------|----------|
| **runcommand_in_parallel_from_file.sh** | Commands from a **file** | You have a command file (e.g. generated `./03_to_sync.sh`). |
| **runcommand_in_parallel_and_log_outcome.sh** | Commands from **stdin** (pipeline) | You pipe commands from another script or `cat file`. |

Both scripts:

- Run each command in parallel up to `max_parallel` jobs.
- Log **failed** commands (and their output) to a failure log file.
- Run each command with a dedicated temp dir (`TMPDIR`/`TEMP`/`TMP`) and remove it afterward.
- Delete any `/tmp/...` path that appears in the command line after the command finishes (e.g. download targets from `jf rt dl`).

---

## runcommand_in_parallel_from_file.sh

Reads **one command per line** from a file. Trims lines and skips empty ones. Prints progress as `[task i of total percent%]`.

### Usage

```text
./runcommand_in_parallel_from_file.sh [--log-success | --success-log <path>] <command_file> <failure_log_file> <max_parallel>
```

### Arguments

| Argument | Description |
|----------|--------------|
| `command_file` | File with one command per line (leading/trailing whitespace trimmed; empty lines skipped). |
| `failure_log_file` | File to append failed commands and their output to. |
| `max_parallel` | Maximum number of commands running at once (positive integer). |

### Options

| Option | Description |
|--------|-------------|
| `--log-success` | Append successful commands to a success log. Path is derived from `failure_log_file`: if it ends with `.txt`, replace with `_success.txt`; otherwise append `_success.txt`. |
| `--success-log <path>` | Append successful commands to `<path>`. |
| `-h`, `--help` | Show usage and exit. |

If neither `--log-success` nor `--success-log` is given, no success log is written.

### Output

- **Success:** `[task <i> of <total> <percent>%] Command successful: <command>`
- **Failure:** `[task <i> of <total> <percent>%] Command failed: <command>`

`percent` is `floor(i * 100 / total)`.

### Examples

Run commands from a generated sync script, log failures to `03_to_sync_out.txt`, use 10 parallel jobs, and log successes to `03_to_sync_out_success.txt`:

```bash
./runcommand_in_parallel_from_file.sh --log-success ./03_to_sync.sh ./03_to_sync_out.txt 10
```

Explicit success log path:

```bash
./runcommand_in_parallel_from_file.sh --success-log ./successes.txt ./05_to_sync_stats.sh ./05_to_sync_stats_out.txt 8
```

No success logging:

```bash
./runcommand_in_parallel_from_file.sh ./06_to_sync_folder_props.sh ./06_out.txt 5
```

---

## runcommand_in_parallel_and_log_outcome.sh

Reads **one command per line** from **standard input**. Trims lines and skips empty ones. Use in a pipeline when commands come from another process or from `cat file`.

### Usage

```text
./runcommand_in_parallel_and_log_outcome.sh <failure_log_file> <max_parallel>
```

Commands are read from stdin; no command file argument.

### Arguments

| Argument | Description |
|----------|-------------|
| `failure_log_file` | File to append failed commands and their output to. |
| `max_parallel` | Maximum number of commands running at once (positive integer). |

### Output

- **Success:** `[task <i>] Command successful: <command>`
- **Failure:** `[task <i>] Command failed: <command>`

Task index `i` is the 1-based index of the command in the input stream. There is no total or percentage (input length is not known in advance when using stdin).

### Examples

Pipe a command file into the script:

```bash
cat test_reconcile_target_only/03_to_sync.sh | ./runcommand_in_parallel_and_log_outcome.sh test_reconcile_target_only/03_to_sync_out.txt 10
```

Pipe from another script:

```bash
./some_script_that_prints_commands.sh | ./runcommand_in_parallel_and_log_outcome.sh failures.txt 16
```

---

## Behavior common to both scripts

- **Concurrency:** At most `max_parallel` commands run at once; the script waits when the limit is reached.
- **Temp isolation:** Each command runs with `TMPDIR`, `TEMP`, and `TMP` set to a new `mktemp -d` directory, which is removed after the command finishes.
- **Cleanup of `/tmp` paths:** After each command, the script looks for paths like `/tmp/...` in the command string (e.g. `"/tmp/abc123"` or `/tmp/abc123`) and runs `rm -rf` on them if they exist. This cleans up download targets used by `jf rt dl` / `jf rt u` style commands.
- **Failure log:** For each failed command, the script appends the command line and the commandâ€™s stdout/stderr to the failure log file.

---

## Which script to use

- **Prefer runcommand_in_parallel_from_file.sh** when you have a **file** of commands (e.g. the generated `0X_to_sync*.sh` scripts): you get progress with total and percent, and optional success logging.
- Use **runcommand_in_parallel_and_log_outcome.sh** when commands are only available via **stdin** (e.g. from a pipeline or a script that prints commands).

For the compare-and-reconcile workflow (see [QUICKSTART.md](QUICKSTART.md)), use **runcommand_in_parallel_from_file.sh** with the generated script as the command file.
