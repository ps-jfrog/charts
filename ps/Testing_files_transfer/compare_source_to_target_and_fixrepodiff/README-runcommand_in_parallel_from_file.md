# runcommand_in_parallel_from_file.sh

Runs shell commands from a file in parallel with a concurrency limit, logs failures, and cleans up temporary files. Used to execute reconciliation scripts generated by **compare-and-reconcile.sh** (e.g. `03_to_sync.sh`, `05_to_sync_stats.sh`).

- Runs each command in parallel up to `max_parallel` jobs.
- Logs **failed** commands (and their output) to a failure log file.
- Runs each command with a dedicated temp dir (`TMPDIR`/`TEMP`/`TMP`) and removes it afterward.
- Deletes any `/tmp/...` path that appears in the command line after the command finishes (e.g. download targets from `jf rt dl`).

---

## Usage

```text
./runcommand_in_parallel_from_file.sh [--log-success | --success-log <path>] <command_file> <failure_log_file> <max_parallel>
```

Reads **one command per line** from the file. Trims lines and skips empty ones. Prints progress as `[task i of total percent%]`.

## Arguments

| Argument | Description |
|----------|--------------|
| `command_file` | File with one command per line (leading/trailing whitespace trimmed; empty lines skipped). |
| `failure_log_file` | File to append failed commands and their output to. |
| `max_parallel` | Maximum number of commands running at once (positive integer). |

## Options

| Option | Description |
|--------|-------------|
| `--log-success` | Append successful commands to a success log. Path is derived from `failure_log_file`: if it ends with `.txt`, replace with `_success.txt`; otherwise append `_success.txt`. |
| `--success-log <path>` | Append successful commands to `<path>`. |
| `-h`, `--help` | Show usage and exit. |

If neither `--log-success` nor `--success-log` is given, no success log is written.

## Output

- **Success:** `[task <i> of <total> <percent>%] Command successful: <command>`
- **Failure:** `[task <i> of <total> <percent>%] Command failed: <command>`

`percent` is `floor(i * 100 / total)`.

## Examples

Run commands from a generated sync script, log failures to `03_to_sync_out.txt`, use 10 parallel jobs, and log successes to `03_to_sync_out_success.txt`:

```bash
./runcommand_in_parallel_from_file.sh --log-success ./03_to_sync.sh ./03_to_sync_out.txt 10
```

Explicit success log path:

```bash
./runcommand_in_parallel_from_file.sh --success-log ./successes.txt ./05_to_sync_stats.sh ./05_to_sync_stats_out.txt 8
```

No success logging:

```bash
./runcommand_in_parallel_from_file.sh ./06_to_sync_folder_props.sh ./06_out.txt 5
```

---

## Behavior details

- **Concurrency:** At most `max_parallel` commands run at once; the script waits when the limit is reached.
- **Temp isolation (per-task /tmp rewrite):** Each command runs with `TMPDIR`, `TEMP`, and `TMP` set to a new `mktemp -d` directory. Before execution, any `/tmp/` paths in the command are **rewritten** to the per-task temp dir so parallel tasks downloading the same SHA1 don't collide or delete each other's files. The per-task temp dir is removed after the command finishes, cleaning up all downloaded files automatically.
- **Failure log:** For each failed command, the script appends the command line and the command's stdout/stderr to the failure log file.

---

## See also

- [README-group_sync_by_sha1.md](README-group_sync_by_sha1.md) — Pre-processor that groups download+upload lines by SHA1 to eliminate duplicate downloads.
- [README-convert_dl_upload_to_rt_cp.md](README-convert_dl_upload_to_rt_cp.md) — Converter for same-Artifactory server-side copy (`jf rt cp`).
- [QUICKSTART.md](QUICKSTART.md) — Full workflow guide.
